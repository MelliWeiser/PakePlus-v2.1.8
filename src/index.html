<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>çŒé€”Â·èœé¸¡Â·èˆªæ½® Â· åœ°å›¾å«æœªæŒ‡å®š</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }

        body {
            background: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 12px;
        }

        .phone-frame {
            max-width: 400px;
            width: 100%;
            background: #ffffff;
            border-radius: 32px;
            box-shadow: 0 20px 35px -8px rgba(0, 0, 0, 0.2), 0 8px 16px -6px rgba(0, 0, 0, 0.1);
            padding: 24px 20px 32px 20px;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        /* å“ç‰Œä¸‰æŒ‰é’® */
        .brand-row {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .btn-brand {
            flex: 1;
            background: #f0f2f5;
            border: none;
            border-radius: 60px;
            padding: 12px 4px;
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            transition: 0.2s;
            cursor: pointer;
            border: 1px solid transparent;
            white-space: nowrap;
        }

        .btn-brand.active {
            background: #1e3c72;
            color: white;
            box-shadow: 0 6px 12px rgba(20, 60, 120, 0.25);
            border-color: #2d4b8a;
        }

        .btn-brand:first-child.active { background: #0f2b4f; }  /* çŒé€”æ·±è‰² */
        .btn-brand:nth-child(2).active { background: #2b4f2b; }  /* èœé¸¡å¢¨ç»¿ */
        .btn-brand:last-child.active { background: #8b4f2b; }  /* èˆªæ½®ç”µç« æ£•è‰²ç³» */

        /* æ¨¡å¼è¡Œ */
        .mode-row {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            background: #f8fafc;
            padding: 8px 12px;
            border-radius: 40px;
        }

        .mode-label {
            font-size: 16px;
            font-weight: 500;
            color: #334155;
            margin-right: 12px;
            padding-left: 6px;
            min-width: 40px;
        }

        .mode-buttons {
            display: flex;
            gap: 10px;
            flex: 1;
        }

        .btn-mode {
            flex: 1;
            background: #e9ecf0;
            border: none;
            border-radius: 30px;
            padding: 10px 0;
            font-size: 16px;
            font-weight: 550;
            color: #1e293b;
            transition: 0.15s;
            cursor: pointer;
            border: 1px solid #d0d7de;
        }

        .btn-mode.active {  
            color: white;
            border-color: #b12a2a;
            box-shadow: 0 4px 8px rgba(220, 50, 50, 0.2);
        }

        /* åœ°å›¾è¡Œ - å¤šæŒ‰é’®å¯æ¢è¡Œï¼Œå¢åŠ æœªæŒ‡å®šæŒ‰é’®åä¾ç„¶å¯å®¹çº³ */
        .map-row {
            display: flex;
            align-items: flex-start;
            margin-bottom: 20px;
            background: #f8fafc;
            padding: 12px 12px;
            border-radius: 30px;
        }

        .map-label {
            font-size: 16px;
            font-weight: 500;
            color: #334155;
            margin-right: 12px;
            padding-left: 6px;
            line-height: 40px;
            min-width: 40px;
        }

        .map-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            flex: 1;
        }

        .btn-map {
            background: #e9ecf0;
            border: none;
            border-radius: 30px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 550;
            color: #1e293b;
            transition: 0.15s;
            cursor: pointer;
            border: 1px solid #d0d7de;
            flex: 0 0 auto;
        }

        .btn-map.active {
            background: #3b82f6;
            color: white;
            border-color: #2563eb;
            box-shadow: 0 4px 8px rgba(59,130,246,0.3);
        }

        /* è¾“å…¥åŸŸé€šç”¨ */
        .input-field {
            margin-bottom: 20px;
        }

        .input-field label {
            display: block;
            font-size: 15px;
            font-weight: 500;
            color: #1e293b;
            margin-bottom: 6px;
        }

        .input-field input {
            width: 100%;
            padding: 16px 18px;
            background: #f8fafc;
            border: 1.5px solid #e2e8f0;
            border-radius: 20px;
            font-size: 16px;
            outline: none;
            transition: 0.15s;
        }

        .input-field input:focus {
            border-color: #3b82f6;
            background: #ffffff;
            box-shadow: 0 4px 10px rgba(59,130,246,0.1);
        }

        /* å“ˆå¤«å¸å¸¦å•ä½è¡Œ */
        .hf-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f8fafc;
            border: 1.5px solid #e2e8f0;
            border-radius: 20px;
            padding: 0 6px 0 0;
            transition: 0.15s;
        }
        .hf-wrapper:focus-within {
            border-color: #3b82f6;
            background: #ffffff;
            box-shadow: 0 4px 10px rgba(59,130,246,0.1);
        }
        .hf-wrapper input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 16px 18px;
            font-size: 16px;
            outline: none;
        }
        .hf-unit {
            padding-right: 16px;
            font-size: 16px;
            font-weight: 500;
            color: #475569;
        }

        /* ä»·æ ¼åŒè¡Œ */
        .price-row {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
        }

        .price-item {
            flex: 1;
        }

        .price-item label {
            display: block;
            font-size: 15px;
            font-weight: 500;
            color: #1e293b;
            margin-bottom: 6px;
        }

        .price-item input {
            width: 100%;
            padding: 16px 18px;
            background: #f8fafc;
            border: 1.5px solid #e2e8f0;
            border-radius: 20px;
            font-size: 16px;
            outline: none;
        }

        .price-item input:focus {
            border-color: #3b82f6;
            background: #ffffff;
        }

        /* IDå­—æ®µ */
        .id-field {
            margin-bottom: 20px;
        }

        .id-field label {
            font-size: 15px;
            font-weight: 500;
            color: #1e293b;
            margin-bottom: 6px;
            display: block;
        }

        .id-field input {
            width: 100%;
            padding: 16px 18px;
            background: #f8fafc;
            border: 1.5px solid #e2e8f0;
            border-radius: 20px;
            font-size: 16px;
            outline: none;
        }

        .id-field input:focus {
            border-color: #3b82f6;
            background: #ffffff;
        }

        /* è®¢å•è¡¨æ ¼åŒºåŸŸ */
        .table-section {
            margin-top: 24px;
            border-top: 2px dashed #d1d9e6;
            padding-top: 16px;
        }
        .table-title {
            font-size: 16px;
            font-weight: 600;
            color: #0f2b4f;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .order-table {
            width: 100%;
            border-collapse: collapse;
            background: #f8fafc;
            border-radius: 16px;
            overflow: hidden;
            font-size: 13px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        }
        .order-table th {
            background: #e6edf5;
            color: #1e3c72;
            font-weight: 600;
            padding: 10px 4px;
            white-space: nowrap;
        }
        .order-table td {
            padding: 8px 4px;
            border-bottom: 1px solid #dce5ef;
            text-align: center;
            color: #1e293b;
        }
        .order-table tbody tr:last-child td {
            border-bottom: none;
        }
        /* æ»šåŠ¨å®¹å™¨ */
        .table-scroll {
            overflow-x: auto;
            border-radius: 16px;
        }

        /* æŒ‰é’®ç»„ */
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        .action-btn {
            flex: 1;
            background: #ffffff;
            border: 1.5px solid #1e3c72;
            border-radius: 40px;
            padding: 14px 10px;
            font-size: 16px;
            font-weight: 600;
            color: #1e3c72;
            cursor: pointer;
            transition: 0.2s;
            text-align: center;
        }
        .action-btn.primary {
            background: #0f2b4f;
            color: white;
            border: none;
            box-shadow: 0 8px 14px -8px #0f2b4f;
        }
        .action-btn.primary:hover {
            background: #1a3f68;
        }
        .action-btn.secondary:hover {
            background: #ebf0f8;
        }

        input[type=number]::-webkit-inner-spin-button { opacity: 0.5; }
        input::placeholder { color: #9aa9b9; font-weight: 400; }
    </style>
</head>
<body>
    <div class="phone-frame">
        <!-- ä¸ŠåŠéƒ¨åˆ†ï¼šä¸‰ä¸ªå“ç‰ŒæŒ‰é’® -->
        <div class="brand-row">
            <button class="btn-brand active" id="btnLietu" type="button">çŒé€”ç”µç«</button>
            <button class="btn-brand" id="btnCaiji" type="button">èœé¸¡ç”µç«</button>
            <button class="btn-brand" id="btnHangchao" type="button">èˆªæ½®ç”µç«</button>
        </div>

        <!-- æ¨¡å¼é€‰æ‹©ï¼šç»å¯† / æœºå¯† -->
        <div class="mode-row">
            <span class="mode-label">æ¨¡å¼</span>
            <div class="mode-buttons">
                <button class="btn-mode active" id="modeJueMi" type="button">ç»å¯†</button>
                <button class="btn-mode" id="modeJiMi" type="button">æœºå¯†</button>
            </div>
        </div>

        <!-- åœ°å›¾é€‰æ‹©ï¼šå¤§å é•¿å¼“æºªè°· å·´å…‹ä»€ èˆªå¤©åŸºåœ° ç›‘ç‹± æœªæŒ‡å®š -->
        <div class="map-row">
            <span class="map-label">åœ°å›¾</span>
            <div class="map-buttons">
                <button class="btn-map active" data-map="å¤§å">å¤§å</button>
                <button class="btn-map" data-map="é•¿å¼“æºªè°·">é•¿å¼“æºªè°·</button>
                <button class="btn-map" data-map="å·´å…‹ä»€">å·´å…‹ä»€</button>
                <button class="btn-map" data-map="èˆªå¤©åŸºåœ°">èˆªå¤©åŸºåœ°</button>
                <button class="btn-map" data-map="ç›‘ç‹±">ç›‘ç‹±</button>
                <button class="btn-map" data-map="æœªæŒ‡å®š">æœªæŒ‡å®š</button>
            </div>
        </div>

        <!-- å“ˆå¤«å¸è¾“å…¥æ¡† (å¸¦å•ä½â€œä¸‡â€) -->
        <div class="input-field hf-field">
            <label>ğŸ”¹ å“ˆå¤«å¸</label>
            <div class="hf-wrapper">
                <input type="number" id="hfValue" placeholder="è¾“å…¥æ•°å­—" step="1" min="0" value="">
                <span class="hf-unit">ä¸‡</span>
            </div>
        </div>

        <!-- æ¥å•ä»·æ ¼ + æ‰“æ‰‹ä»·æ ¼ å¹¶æ’ -->
        <div class="price-row">
            <div class="price-item">
                <label>ğŸ’° æ¥å•ä»·æ ¼</label>
                <input type="number" id="receivePrice" placeholder="æ¥å•ä»·æ ¼" step="0.01" min="0">
            </div>
            <div class="price-item">
                <label>âš”ï¸ æ‰“æ‰‹ä»·æ ¼</label>
                <input type="number" id="fighterPrice" placeholder="æ‰“æ‰‹ä»·æ ¼" step="0.01" min="0">
            </div>
        </div>

        <!-- æ‰“æ‰‹ID + å†å²è®°å½•ä¸‹æ‹‰æç¤º -->
        <div class="id-field">
            <label>ğŸ†” æ‰“æ‰‹ ID (å¯è¾“å‰å­—ç¬¦åŒ¹é…å†å²)</label>
            <input type="text" id="fighterId" list="fighterHistory" placeholder="è¾“å…¥æ‰“æ‰‹ID æˆ– ä»åˆ—è¡¨é€‰æ‹©">
            <datalist id="fighterHistory"></datalist>
        </div>

        <!-- è€æ¿ID -->
        <div class="id-field">
            <label>ğŸ‘‘ è€æ¿ ID</label>
            <input type="text" id="bossId" placeholder="è¾“å…¥è€æ¿ID">
        </div>

        <!-- è¾“å‡ºè®¢å•æŒ‰é’® (æ·»åŠ åˆ°è¡¨æ ¼å¹¶æ¸…ç©ºè¾“å…¥æ¡†) -->
        <button class="action-btn primary" id="addOrderBtn" style="width:100%; margin-bottom:12px;">ğŸ“‹ è¾“å‡ºè®¢å• (æ·»åŠ åˆ°è¡¨æ ¼)</button>

        <!-- è¡¨æ ¼åŒºåŸŸï¼šç´¯ç§¯è®¢å• -->
        <div class="table-section">
            <div class="table-title">
                <span>ğŸ“Š è®¢å•è®°å½•è¡¨</span>
                <span style="font-size:13px; color:#4b6584;">å…± <span id="orderCount">0</span> æ¡</span>
            </div>
            <div class="table-scroll">
                <table class="order-table" id="orderTable">
                    <thead>
                        <tr>
                            <th>å“ç‰Œ</th>
                            <th>æ¨¡å¼</th>
                            <th>åœ°å›¾</th>
                            <th>å“ˆå¤«å¸(ä¸‡)</th>
                            <th>æ¥å•ä»·</th>
                            <th>æ‰“æ‰‹ä»·</th>
                            <th>æ‰“æ‰‹ID</th>
                            <th>è€æ¿ID</th>
                            <th>æ—¶é—´</th>
                            <th>åˆ©æ¶¦</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- åŠ¨æ€æ·»åŠ çš„è¡Œä¼šå‡ºç°åœ¨è¿™é‡Œ -->
                    </tbody>
                </table>
            </div>
            <!-- å¯¼å‡ºå…¨éƒ¨è®¢å•æŒ‰é’® + æ¸…ç©ºè¡¨æ ¼ -->
            <div class="button-group">
                <button class="action-btn secondary" id="exportAllBtn">ğŸ“ å¯¼å‡ºå…¨éƒ¨è®¢å•</button>
                <button class="action-btn secondary" id="clearTableBtn">ğŸ—‘ï¸ æ¸…ç©ºè¡¨æ ¼</button>
            </div>
        </div>
    </div>

    <script>
        (function() {
            // --- è·å–å…ƒç´  ---
            const btnLietu = document.getElementById('btnLietu');
            const btnCaiji = document.getElementById('btnCaiji');
            const btnHangchao = document.getElementById('btnHangchao');
            const brandBtns = [btnLietu, btnCaiji, btnHangchao];

            const modeJueMi = document.getElementById('modeJueMi');
            const modeJiMi = document.getElementById('modeJiMi');
            const modeBtns = [modeJueMi, modeJiMi];

            // åœ°å›¾æŒ‰é’® (åŒ…å«æ–°å¢çš„â€œæœªæŒ‡å®šâ€)
            const mapBtns = Array.from(document.querySelectorAll('.btn-map'));

            // è¾“å…¥å­—æ®µ
            const hfInput = document.getElementById('hfValue');
            const receiveInput = document.getElementById('receivePrice');
            const fighterPriceInput = document.getElementById('fighterPrice');
            const fighterIdInput = document.getElementById('fighterId');
            const bossIdInput = document.getElementById('bossId');

            // æŒ‰é’®
            const addOrderBtn = document.getElementById('addOrderBtn');
            const exportAllBtn = document.getElementById('exportAllBtn');
            const clearTableBtn = document.getElementById('clearTableBtn');
            const tableBody = document.getElementById('tableBody');
            const orderCountSpan = document.getElementById('orderCount');

            // æ‰“æ‰‹IDå†å²è®°å½• (å»é‡)
            let fighterHistoryList = [];
            const datalist = document.getElementById('fighterHistory');

            // --- æ›´æ–°datalisté€‰é¡¹ ---
            function updateFighterDatalist() {
                datalist.innerHTML = '';
                fighterHistoryList.forEach(id => {
                    const option = document.createElement('option');
                    option.value = id;
                    datalist.appendChild(option);
                });
            }

            // --- æ·»åŠ æ‰“æ‰‹IDåˆ°å†å² (å¦‚æœéç©ºä¸”æœªå­˜åœ¨) ---
            function addFighterIdToHistory(id) {
                const trimmed = id.trim();
                if (trimmed === '') return;
                if (!fighterHistoryList.includes(trimmed)) {
                    fighterHistoryList.push(trimmed);
                    updateFighterDatalist();
                }
            }

            // --- å“ç‰Œåˆ‡æ¢ (äº’æ–¥é«˜äº®) ---
            brandBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    brandBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // --- æ¨¡å¼åˆ‡æ¢ (äº’æ–¥é«˜äº® + ç‰¹æ®Šé¢œè‰²) ---
            function setModeActive(activeBtn) {
                modeBtns.forEach(btn => {
                    btn.classList.remove('active');
                    btn.style.backgroundColor = '';   // æ¸…é™¤å†…è”èƒŒæ™¯
                    btn.style.color = '';
                });
                activeBtn.classList.add('active');

                if (activeBtn === modeJueMi) {
                    activeBtn.style.backgroundColor = '#b22222'; // æ·±çº¢
                } else if (activeBtn === modeJiMi) {
                    activeBtn.style.backgroundColor = '#d97706'; // æ©™
                }
                activeBtn.style.color = 'white';
            }

            setModeActive(modeJueMi);
            modeJueMi.addEventListener('click', function() { setModeActive(modeJueMi); });
            modeJiMi.addEventListener('click', function() { setModeActive(modeJiMi); });

            // --- åœ°å›¾åˆ‡æ¢ (äº’æ–¥é«˜äº®) ---
            function setMapActive(activeBtn) {
                mapBtns.forEach(btn => btn.classList.remove('active'));
                activeBtn.classList.add('active');
            }

            // é»˜è®¤ç¬¬ä¸€ä¸ªåœ°å›¾ï¼ˆå¤§åï¼‰å·²æ¿€æ´»ï¼Œä½†ä»¥é˜²ä¸‡ä¸€
            if (!mapBtns.some(btn => btn.classList.contains('active'))) {
                mapBtns[0].classList.add('active');
            }

            mapBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    setMapActive(this);
                });
            });

            // --- è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–å½“å‰æ—¶é—´ YYYY-MM-DD HH:MM:SS ---
            function getCurrentTime() {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            }

            // --- è®¡ç®—åˆ©æ¶¦ (æ¥å• - æ‰“æ‰‹) ä¿ç•™ä¸¤ä½å°æ•°ï¼Œæ— æ•ˆè¿”å›ç©ºå­—ç¬¦ä¸² ---
            function calculateProfit(receive, fighter) {
                const r = parseFloat(receive);
                const f = parseFloat(fighter);
                if (!isNaN(r) && !isNaN(f)) {
                    return (r - f).toFixed(2);
                }
                return ''; // è¾“å…¥æ— æ•ˆæ—¶æ˜¾ç¤ºç©ºç™½
            }

            // --- æ›´æ–°è®¢å•è®¡æ•° ---
            function updateOrderCount() {
                const count = tableBody.children.length;
                orderCountSpan.textContent = count;
            }

            // --- æ·»åŠ å½“å‰è®¢å•åˆ°è¡¨æ ¼ ---
            function addCurrentOrderToTable() {
                // è·å–å“ç‰Œ
                const activeBrand = brandBtns.find(btn => btn.classList.contains('active'));
                const brand = activeBrand ? activeBrand.innerText.trim() : 'çŒé€”ç”µç«';

                // è·å–æ¨¡å¼
                const activeMode = modeBtns.find(btn => btn.classList.contains('active'));
                const mode = activeMode ? activeMode.innerText.trim() : 'ç»å¯†';

                // è·å–åœ°å›¾
                const activeMap = mapBtns.find(btn => btn.classList.contains('active'));
                const map = activeMap ? activeMap.innerText.trim() : 'å¤§å';

                // è·å–å„è¾“å…¥å€¼ (ä¿ç•™åŸå§‹å­—ç¬¦ä¸²)
                const hf = hfInput.value.trim() || '';
                const receive = receiveInput.value.trim() || '';
                const fighterPrice = fighterPriceInput.value.trim() || '';
                const fighterId = fighterIdInput.value.trim() || '';
                const bossId = bossIdInput.value.trim() || '';

                // å°†æ‰“æ‰‹IDåŠ å…¥å†å²è®°å½•
                addFighterIdToHistory(fighterId);

                // ç”Ÿæˆæ—¶é—´
                const timeStr = getCurrentTime();

                // è®¡ç®—åˆ©æ¶¦
                const profit = calculateProfit(receive, fighterPrice);

                // åˆ›å»ºæ–°è¡Œ (æ³¨æ„åˆ—é¡ºåºä¸è¡¨å¤´ä¸€è‡´)
                const newRow = document.createElement('tr');

                newRow.innerHTML = `
                    <td>${brand}</td>
                    <td>${mode}</td>
                    <td>${map}</td>
                    <td>${hf}</td>
                    <td>${receive}</td>
                    <td>${fighterPrice}</td>
                    <td>${fighterId}</td>
                    <td>${bossId}</td>
                    <td>${timeStr}</td>
                    <td>${profit}</td>
                `;

                tableBody.appendChild(newRow);
                updateOrderCount();

                // --- æ¸…ç©ºæ‰€æœ‰è¾“å…¥æ¡† (ä½†ä¸å½±å“å“ç‰Œ/æ¨¡å¼/åœ°å›¾é€‰æ‹©) ---
                hfInput.value = '';
                receiveInput.value = '';
                fighterPriceInput.value = '';
                fighterIdInput.value = '';
                bossIdInput.value = '';
            }

            // --- æ¸…ç©ºè¡¨æ ¼ (ä½†ä¿ç•™å†å²è®°å½•, ä¸æ¸…é™¤) ---
            function clearTable() {
                tableBody.innerHTML = '';
                updateOrderCount();
            }

            // --- å¯¼å‡ºæ•´ä¸ªè¡¨æ ¼ä¸ºCSV (åŒ…å«è¡¨å¤´) ---
            function exportAllToCSV() {
                const table = document.getElementById('orderTable');
                const rows = table.querySelectorAll('tr'); 
                const csvData = [];

                // è¡¨å¤´
                const headerCells = table.querySelectorAll('thead th');
                const headerRow = Array.from(headerCells).map(th => th.innerText.trim());
                csvData.push(headerRow);

                // æ•°æ®è¡Œ
                const dataRows = tableBody.querySelectorAll('tr');
                dataRows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    const rowData = Array.from(cells).map(td => td.innerText.trim());
                    csvData.push(rowData);
                });

                // è½¬æ¢ä¸ºCSV
                const escapeCSV = (cell) => {
                    if (cell === null || cell === undefined) cell = '';
                    cell = String(cell);
                    if (cell.includes(',') || cell.includes('\n') || cell.includes('"')) {
                        cell = '"' + cell.replace(/"/g, '""') + '"';
                    }
                    return cell;
                };

                const csvContent = csvData.map(row => row.map(escapeCSV).join(',')).join('\n');

                // æ·»åŠ BOM
                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                const now = new Date();
                const dateStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')} ${now.getHours().toString().padStart(2,'0')}.${now.getMinutes().toString().padStart(2,'0')}`;
                link.download = `å…¨éƒ¨è®¢å•_${dateStr}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            // --- ç»‘å®šäº‹ä»¶ ---
            addOrderBtn.addEventListener('click', function() {
                addCurrentOrderToTable();
                // è¾“å…¥æ¡†å·²åœ¨æ·»åŠ å‡½æ•°å†…éƒ¨æ¸…ç©º
            });

            exportAllBtn.addEventListener('click', function() {
                if (tableBody.children.length === 0) {
                    alert('å½“å‰è¡¨æ ¼ä¸ºç©ºï¼Œæš‚æ— è®¢å•å¯å¯¼å‡ºã€‚');
                    return;
                }
                exportAllToCSV();
            });

            clearTableBtn.addEventListener('click', function() {
                if (tableBody.children.length > 0) {
                    if (confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰è®¢å•è®°å½•å—ï¼Ÿå†å²æ‰“æ‰‹IDå»ºè®®ä»ä¼šä¿ç•™ã€‚')) {
                        clearTable();
                    }
                } else {
                    alert('è¡¨æ ¼å·²ç»æ˜¯ç©ºçš„ã€‚');
                }
            });

            // åˆå§‹åŒ–è®¡æ•°
            updateOrderCount();
        })();
    </script>
</body>
</html>